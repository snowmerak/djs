import React from 'react'
import {
  Box,
  Container,
  Heading,
  Text,
  Button,
  Input,
  FormControl,
  FormLabel,
  VStack,
  HStack,
  Table,
  Thead,
  Tbody,
  Tr,
  Th,
  Td,
  TableContainer,
  Badge,
  IconButton,
  useToast,
  Flex,
  Card,
  CardHeader,
  CardBody,
  Divider,
  Alert,
  AlertIcon,
  AlertDescription,
} from '@chakra-ui/react'
import { DeleteIcon, CopyIcon, SettingsIcon, RepeatIcon } from '@chakra-ui/icons'

function App() {
  const [streamerId, setStreamerId] = React.useState('')
  const [prefix, setPrefix] = React.useState('!Ïã†Ï≤≠')
  const [isConnected, setIsConnected] = React.useState(false)
  const [connectionMessage, setConnectionMessage] = React.useState('')
  const [connectionStatus, setConnectionStatus] = React.useState('disconnected')
  const [songRequests, setSongRequests] = React.useState([])
  const [showSettings, setShowSettings] = React.useState(true)
  const toast = useToast()

  React.useEffect(() => {
    // Electron API Ï°¥Ïû¨ ÌôïÏù∏
    if (!window.electronAPI) {
      console.error('Electron API not available')
      toast({
        title: 'Ïò§Î•ò',
        description: 'Electron APIÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§',
        status: 'error',
        duration: 5000,
        isClosable: true,
      })
      return
    }

    // Ïó∞Í≤∞ ÏÉÅÌÉú Î¶¨Ïä§ÎÑà
    window.electronAPI.onConnectionStatus((data) => {
      setConnectionMessage(data.message)
      setConnectionStatus(data.status)
      
      if (data.status === 'connected' || data.status === 'entered') {
        setIsConnected(true)
        toast({
          title: 'Ïó∞Í≤∞ ÏÑ±Í≥µ',
          description: data.message,
          status: 'success',
          duration: 3000,
          isClosable: true,
        })
      } else if (data.status === 'disconnected') {
        setIsConnected(false)
      } else if (data.status === 'error') {
        setIsConnected(false)
        toast({
          title: 'Ïó∞Í≤∞ Ïò§Î•ò',
          description: data.message,
          status: 'error',
          duration: 5000,
          isClosable: true,
        })
      }
    })

    // Ïã†Ï≤≠Í≥° Î¶¨Ïä§ÎÑà
    window.electronAPI.onNewSongRequest((data) => {
      setSongRequests(prev => [...prev, data])
      toast({
        title: 'ÏÉà Ïã†Ï≤≠Í≥°',
        description: `${data.username}: ${data.songRequest}`,
        status: 'info',
        duration: 2000,
        isClosable: true,
      })
    })

    return () => {
      window.electronAPI.removeAllListeners('connection-status')
      window.electronAPI.removeAllListeners('new-song-request')
    }
  }, [toast])

  const handleConnect = async () => {
    if (!streamerId.trim()) {
      toast({
        title: 'ÏûÖÎ†• Ïò§Î•ò',
        description: 'Ïä§Ìä∏Î¶¨Î®∏ IDÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî',
        status: 'warning',
        duration: 3000,
        isClosable: true,
      })
      return
    }
    if (!prefix.trim()) {
      toast({
        title: 'ÏûÖÎ†• Ïò§Î•ò',
        description: 'Ïã†Ï≤≠Í≥° prefixÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî',
        status: 'warning',
        duration: 3000,
        isClosable: true,
      })
      return
    }

    try {
      await window.electronAPI.connectChat(streamerId.trim(), prefix.trim())
      setShowSettings(false)
    } catch (error) {
      toast({
        title: 'Ïó∞Í≤∞ Ïã§Ìå®',
        description: error.message,
        status: 'error',
        duration: 5000,
        isClosable: true,
      })
    }
  }

  const handleDisconnect = async () => {
    try {
      await window.electronAPI.disconnectChat()
      setIsConnected(false)
      toast({
        title: 'Ïó∞Í≤∞ Ìï¥Ï†ú',
        description: 'Ï±ÑÌåÖ Ïó∞Í≤∞Ïù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§',
        status: 'info',
        duration: 3000,
        isClosable: true,
      })
    } catch (error) {
      toast({
        title: 'Ïó∞Í≤∞ Ìï¥Ï†ú Ïã§Ìå®',
        description: error.message,
        status: 'error',
        duration: 5000,
        isClosable: true,
      })
    }
  }

  const handleClearList = () => {
    if (window.confirm('Ïã†Ï≤≠Í≥° Î™©Î°ùÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
      setSongRequests([])
      toast({
        title: 'Î™©Î°ù Ï¥àÍ∏∞Ìôî',
        description: 'Ïã†Ï≤≠Í≥° Î™©Î°ùÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§',
        status: 'success',
        duration: 2000,
        isClosable: true,
      })
    }
  }

  const handleRemoveRequest = (index) => {
    setSongRequests(prev => prev.filter((_, i) => i !== index))
  }

  const handleCopyList = () => {
    const text = songRequests
      .map((req, idx) => `${idx + 1}. [${req.timestamp}] ${req.username}: ${req.songRequest}`)
      .join('\n')
    
    navigator.clipboard.writeText(text)
      .then(() => {
        toast({
          title: 'Î≥µÏÇ¨ ÏôÑÎ£å',
          description: 'Î™©Î°ùÏù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§',
          status: 'success',
          duration: 2000,
          isClosable: true,
        })
      })
      .catch(err => {
        toast({
          title: 'Î≥µÏÇ¨ Ïã§Ìå®',
          description: err.message,
          status: 'error',
          duration: 3000,
          isClosable: true,
        })
      })
  }

  const getStatusColor = () => {
    if (connectionStatus === 'connected' || connectionStatus === 'entered') return 'green'
    if (connectionStatus === 'reconnecting') return 'yellow'
    if (connectionStatus === 'error') return 'red'
    return 'gray'
  }

  return (
    <Box minH="100vh" bgGradient="linear(to-br, purple.400, purple.600)">
      {/* Header */}
      <Box bg="white" shadow="md" py={4} px={6}>
        <Flex justify="space-between" align="center" maxW="1400px" mx="auto">
          <Heading size="lg" color="purple.600">
            üéµ SOOP DJ Helper
          </Heading>
          <HStack spacing={3}>
            <Badge
              colorScheme={getStatusColor()}
              fontSize="md"
              px={3}
              py={1}
              borderRadius="full"
            >
              {isConnected ? '‚óè Ïó∞Í≤∞Îê®' : '‚óã Ïó∞Í≤∞ ÏïàÎê®'}
            </Badge>
            {connectionMessage && (
              <Text fontSize="sm" color="gray.600">
                {connectionMessage}
              </Text>
            )}
          </HStack>
        </Flex>
      </Box>

      {/* Main Content */}
      <Container maxW="1400px" py={8}>
        {showSettings ? (
          <Card maxW="500px" mx="auto">
            <CardHeader>
              <Heading size="md">‚öôÔ∏è ÏÑ§Ï†ï</Heading>
            </CardHeader>
            <CardBody>
              <VStack spacing={4} align="stretch">
                <FormControl>
                  <FormLabel>Ïä§Ìä∏Î¶¨Î®∏ ID</FormLabel>
                  <Input
                    value={streamerId}
                    onChange={(e) => setStreamerId(e.target.value)}
                    placeholder="Ïòà: beststreamer"
                    isDisabled={isConnected}
                    size="lg"
                  />
                </FormControl>

                <FormControl>
                  <FormLabel>Ïã†Ï≤≠Í≥° Prefix</FormLabel>
                  <Input
                    value={prefix}
                    onChange={(e) => setPrefix(e.target.value)}
                    placeholder="Ïòà: !Ïã†Ï≤≠"
                    isDisabled={isConnected}
                    size="lg"
                  />
                </FormControl>

                <Divider />

                <HStack spacing={3}>
                  {!isConnected ? (
                    <Button
                      colorScheme="purple"
                      size="lg"
                      onClick={handleConnect}
                      width="full"
                    >
                      Ïó∞Í≤∞ÌïòÍ∏∞
                    </Button>
                  ) : (
                    <>
                      <Button
                        colorScheme="gray"
                        size="lg"
                        onClick={() => setShowSettings(false)}
                        flex={1}
                      >
                        Ïã†Ï≤≠Í≥° Î™©Î°ù Î≥¥Í∏∞
                      </Button>
                      <Button
                        colorScheme="red"
                        size="lg"
                        onClick={handleDisconnect}
                        flex={1}
                      >
                        Ïó∞Í≤∞ Ìï¥Ï†ú
                      </Button>
                    </>
                  )}
                </HStack>
              </VStack>
            </CardBody>
          </Card>
        ) : (
          <Card>
            <CardHeader>
              <Flex justify="space-between" align="center" flexWrap="wrap" gap={3}>
                <Heading size="md">
                  üìã Ïã†Ï≤≠Í≥° Î™©Î°ù ({songRequests.length})
                </Heading>
                <HStack spacing={2} flexWrap="wrap">
                  <Button
                    leftIcon={<SettingsIcon />}
                    colorScheme="gray"
                    onClick={() => setShowSettings(true)}
                    size="sm"
                  >
                    ÏÑ§Ï†ï
                  </Button>
                  <Button
                    leftIcon={<CopyIcon />}
                    colorScheme="blue"
                    onClick={handleCopyList}
                    isDisabled={songRequests.length === 0}
                    size="sm"
                  >
                    Î≥µÏÇ¨
                  </Button>
                  <Button
                    leftIcon={<RepeatIcon />}
                    colorScheme="orange"
                    onClick={handleClearList}
                    isDisabled={songRequests.length === 0}
                    size="sm"
                  >
                    Ï¥àÍ∏∞Ìôî
                  </Button>
                </HStack>
              </Flex>
            </CardHeader>
            <CardBody>
              {songRequests.length === 0 ? (
                <Alert
                  status="info"
                  variant="subtle"
                  flexDirection="column"
                  alignItems="center"
                  justifyContent="center"
                  textAlign="center"
                  minH="200px"
                  borderRadius="md"
                >
                  <AlertIcon boxSize="40px" mr={0} />
                  <Text mt={4} mb={1} fontSize="lg" fontWeight="bold">
                    ÏïÑÏßÅ Ïã†Ï≤≠Í≥°Ïù¥ ÏóÜÏäµÎãàÎã§
                  </Text>
                  <AlertDescription maxWidth="sm">
                    &quot;{prefix}&quot;Î°ú ÏãúÏûëÌïòÎäî Ï±ÑÌåÖÏù¥ ÏàòÏßëÎê©ÎãàÎã§
                  </AlertDescription>
                </Alert>
              ) : (
                <TableContainer maxH="60vh" overflowY="auto">
                  <Table variant="simple" size="sm">
                    <Thead position="sticky" top={0} bg="gray.50" zIndex={1}>
                      <Tr>
                        <Th>#</Th>
                        <Th>ÏãúÍ∞Ñ</Th>
                        <Th>Ïú†Ï†ÄÎ™Ö</Th>
                        <Th>Ïã†Ï≤≠Í≥°</Th>
                        <Th>Ï†ÑÏ≤¥ Î©îÏãúÏßÄ</Th>
                        <Th>ÏÇ≠Ï†ú</Th>
                      </Tr>
                    </Thead>
                    <Tbody>
                      {songRequests.map((request, index) => (
                        <Tr
                          key={`${request.timestamp}-${request.userId}-${index}`}
                          _hover={{ bg: 'gray.50' }}
                        >
                          <Td>{index + 1}</Td>
                          <Td>
                            <Text fontSize="sm" color="gray.600">
                              {new Date(request.timestamp).toLocaleTimeString('ko-KR')}
                            </Text>
                          </Td>
                          <Td>
                            <Text fontWeight="bold" color="purple.600">
                              {request.username}
                            </Text>
                          </Td>
                          <Td>
                            <Text fontWeight="semibold">{request.songRequest}</Text>
                          </Td>
                          <Td>
                            <Text fontSize="sm" color="gray.600">
                              {request.comment}
                            </Text>
                          </Td>
                          <Td>
                            <IconButton
                              aria-label="ÏÇ≠Ï†ú"
                              icon={<DeleteIcon />}
                              size="sm"
                              colorScheme="red"
                              variant="ghost"
                              onClick={() => handleRemoveRequest(index)}
                            />
                          </Td>
                        </Tr>
                      ))}
                    </Tbody>
                  </Table>
                </TableContainer>
              )}
            </CardBody>
          </Card>
        )}
      </Container>

      {/* Footer */}
      <Box bg="whiteAlpha.900" py={4} mt={8}>
        <Container maxW="1400px">
          <Text textAlign="center" color="gray.600" fontSize="sm">
            SOOP DJ Helper v1.0 - Ïä§Ìä∏Î¶¨Î®∏Î•º ÏúÑÌïú Ïã†Ï≤≠Í≥° Í¥ÄÎ¶¨ ÎèÑÍµ¨
          </Text>
        </Container>
      </Box>
    </Box>
  )
}

export default App
